apply plugin: 'assembler'
apply plugin: 'c'

task downloadBinutils(type: Downloader) {
    sourceUrl = 'http://ftp.gnu.org/gnu/binutils/binutils-2.39.tar.gz'
    target = file('binutils-2.39.tar.gz')
}

task untarBinutils (type: Copy) {
    from tarTree(resources.gzip('binutils-2.39.tar.gz'))
    into getProjectDir().getAbsolutePath()  + "//src"
}

untarBinutils.dependsOn downloadBinutils

/* -------------------------------- arm-eabi --------------------------- */

task setupBinutilsArm (type: BuildSetup) {
    root = getProjectDir().getAbsolutePath()
    target = 'arm-eabi'
}

setupBinutilsArm.dependsOn untarBinutils

task configureBinutilsArm (type:Exec) {
  workingDir getProjectDir().getAbsolutePath() + "//build-arm-eabi"
  commandLine 'bash',
    '-c',
    'rm -rf *;../src/binutils-2.39/configure --prefix=' + getProjectDir().getAbsolutePath().replace("\\","/") + '/../arm-eabi --target=arm-eabi --enable-multilib --enable-lto --disable-libstdcxx --disable-libquadmath --disable-nls --enable-interwork'
}

configureBinutilsArm.dependsOn setupBinutilsArm

task makeBinutilsArm (type:Exec) {
    workingDir getProjectDir().getAbsolutePath() + "//build-arm-eabi"
    commandLine 'bash',
        '-c',
        project.getProperties().get("MAKE") + ' -' + project.getProperties().get("CONBUILDS")
}

makeBinutilsArm.dependsOn configureBinutilsArm

task makeInstallBintutilsArm (type:Exec) {
    workingDir getProjectDir().getAbsolutePath() + "//build-arm-eabi"
    commandLine 'bash',
        '-c',
        project.getProperties().get("MAKE") + ' install'
}

makeInstallBintutilsArm.dependsOn makeBinutilsArm

/* -------------------------------- x86_64-elf --------------------------- */

task setupBinutilsX86_64 (type: BuildSetup) {
    root = getProjectDir().getAbsolutePath()
    target = 'x86_64-elf'
}

setupBinutilsX86_64.dependsOn untarBinutils

task configureBinutilsX86_64 (type:Exec) {
  workingDir getProjectDir().getAbsolutePath() + "//build-x86_64-elf"
  commandLine 'bash',
    '-c',
    'rm -rf *;../src/binutils-2.39/configure --prefix=' + getProjectDir().getAbsolutePath().replace("\\","/") + '/../x86_64-elf --target=x86_64-elf --enable-multilib --enable-lto --disable-libstdcxx --disable-libquadmath --disable-nls --enable-interwork'
}

configureBinutilsX86_64.dependsOn setupBinutilsX86_64

task makeBinutilsX86_64 (type:Exec) {
    workingDir getProjectDir().getAbsolutePath() + "//build-x86_64-elf"
    commandLine 'bash',
        '-c',
        project.getProperties().get("MAKE") + ' -' + project.getProperties().get("CONBUILDS")
}

makeBinutilsX86_64.dependsOn configureBinutilsX86_64

task makeInstallBintutilsX86_64 (type:Exec) {
    workingDir getProjectDir().getAbsolutePath() + "//build-x86_64-elf"
    commandLine 'bash',
        '-c',
        project.getProperties().get("MAKE") + ' install'
}

makeInstallBintutilsX86_64.dependsOn makeBinutilsX86_64

/* -------------------------------- clean --------------------------- */

task cleanBinUtils(type:Exec) {
	commandLine 'bash',
		'-c',
		'rm -rf build-arm-eabi;\
		 rm -rf build-x86_64-elf;\
		 rm -rf src;\
		 rm -rf *.tar.gz'
}

cleanBinUtils.outputs.upToDateWhen {false}
clean.finalizedBy(cleanBinUtils)

class Downloader extends DefaultTask {
    @Input
    String sourceUrl

    @OutputFile
    File target

    @TaskAction
    void download() {
        ant.get(src: sourceUrl, dest: target)
    }
}

class BuildSetup extends DefaultTask {
    @Input
    String root
    @Input
    String target

    @TaskAction
    void setup() {
        java.io.File path = new File(root + "//build-" + target)
        path.mkdirs();
    }
}
